import React,{useEffect,useState} from 'react'; import API from '../api'; export default function MessageForm({classId,onSent}){ const [subject,setSubject]=useState(''); const [body,setBody]=useState(''); const [students,setStudents]=useState([]); const [selected,setSelected]=useState(new Set()); const [assignAll,setAssignAll]=useState(true); const [sending,setSending]=useState(false); useEffect(()=>{ if(!classId) return; API.get(`/classes/${classId}/roster`).then(r=>setStudents(r.data.filter(s=>s.role==='student'))).catch(()=>setStudents([])); },[classId]); function toggle(uid){ const s=new Set(selected); if(s.has(uid)) s.delete(uid); else s.add(uid); setSelected(s); if(s.size>0) setAssignAll(false); } async function submit(e){ e.preventDefault(); if(!body) return alert('Write a message'); setSending(true); try{ const payload={subject,body}; if(!assignAll && selected.size>0) payload.target_student_ids=Array.from(selected); await API.post(`/classes/${classId}/messages`, payload); setSubject(''); setBody(''); setSelected(new Set()); setAssignAll(true); if(onSent) onSent(); }catch(err){ alert('Send failed: '+(err.response?.data?.error||err.message)); } finally{ setSending(false); } } return (<form onSubmit={submit} className='card' style={{marginBottom:12}}><h3 style={{marginTop:0}}>New message</h3><input placeholder='Subject (optional)' value={subject} onChange={e=>setSubject(e.target.value)} className='w-full p-2 border rounded' /><textarea placeholder='Write message...' value={body} onChange={e=>setBody(e.target.value)} className='w-full p-2 border rounded' rows={5} style={{marginTop:8}} /><div style={{marginTop:8}}><label><input type='checkbox' checked={assignAll} onChange={e=>{setAssignAll(e.target.checked); if(e.target.checked) setSelected(new Set());}}/> <span style={{marginLeft:8}}>Send to entire class</span></label></div>{!assignAll && (<div style={{marginTop:8,maxHeight:160,overflow:'auto',border:'1px solid rgba(0,0,0,0.05)',padding:8,borderRadius:8}}>{students.map(s=> (<label key={s.id} style={{display:'flex',alignItems:'center',gap:8,padding:'6px 0'}}><input type='checkbox' checked={selected.has(s.id)} onChange={()=>toggle(s.id)} /><div><div style={{fontWeight:600}}>{s.name}</div><div className='small-muted'>{s.email}</div></div></label>))}</div>)}<div style={{marginTop:10,display:'flex',gap:8}}><button type='submit' disabled={sending} className='btn btn-primary'>{sending?'Sendingâ€¦':'Send'}</button></div></form>); }